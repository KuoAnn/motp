<!DOCTYPE html>
<html>

<head>
  <title>MOTP</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    html {
      margin: 0;
      padding: 0;
      min-width: 300px;
      min-height: 350px
    }

    body,
    button {
      margin: 0;
      padding: 10px;
      font-size: 20px !important;
      font-family: Verdana, Geneva, Tahoma, sans-serif
    }

    button {
      width: 100%;
      height: 60px;
      border-radius: 4px;
      border: 1px solid #aaa;
      background-color: #87cefa;
      cursor: pointer
    }

    button:hover {
      color: #fff;
      background-color: #b0c4de
    }

    input[type=text] {
      width: 95%;
      margin: 0;
      padding: 6px;
      font-size: 16px !important
    }

    #password-text {
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background-color: #eee;
      color: red;
      text-align: center;
      font-size: 50px
    }
  </style>
</head>

<body>
  <div>Pin (4 碼數字)</div>
  <input type="text" id="pin" name="pin" class="form-control" value="" />
  <div>
    <div>Secret (16 碼密鑰)</div>
    <input type="text" id="secret" name="secret" value="" class="form-control" />
  </div>
  <div>
    <label style="float: right">
      <input type="checkbox" id="save" name="save" checked="checked" />
      儲存本機
    </label>
  </div>
  <div style="clear: both"></div>

  <div>
    <button id="copy" class="btn btn-success">Copy</button>
  </div>
  <hr />

  <div>
    <label style="float:left">Password</label>
    <label style="float:right">
      <i id="copied" style="display:none;color:darkslategrey">
        <svg width="20" height="20" viewBox="0 0 512 512">
          <path fill="currentColor"
            d="M288 448H64V224h64v-64H64c-35.3 0-64 28.7-64 64v224c0 35.3 28.7 64 64 64h224c35.3 0 64-28.7 64-64v-64h-64v64zm-64-96h224c35.3 0 64-28.7 64-64V64c0-35.3-28.7-64-64-64H224c-35.3 0-64 28.7-64 64v224c0 35.3 28.7 64 64 64z" />
        </svg></i>
    </label>
    <div style="clear:both"></div>

    <div id="password-text"></div>
  </div>
</body>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let oldPassword = "";

    if (localStorage.getItem("save")) {
      document.querySelector("#pin").value = localStorage.getItem("pin");
      document.querySelector("#secret").value = localStorage.getItem("secret");
      document.querySelector("#save").checked = true;
      document.querySelector("#copy").addEventListener("click", copyPassword);
    }

    function genPassword() {
      var pin = document.querySelector("#pin").value;
      var secret = document.querySelector("#secret").value;
      var save = document.querySelector("#save").checked;

      if (save) {
        localStorage.setItem("pin", pin);
        localStorage.setItem("secret", secret);
        localStorage.setItem("save", true);
      } else {
        localStorage.setItem("pin", pin);
        localStorage.setItem("secret", secret);
        localStorage.setItem("save", false);
      }

      var tm = Math.floor(new Date().getTime() / 1000 / 10);
      var opt = md5(tm + secret + pin);
      var password = opt.substr(0, 6);

      if (password != oldPassword) {
        oldPassword = password;
        document.querySelector("#copied").style.display = "none";
        document.querySelector("#password-text").innerHTML = password;
        // copyPassword();
      }
    }

    function copyPassword() {
      navigator.clipboard
        .writeText(oldPassword)
        .then(() => {
          document.querySelector("#copied").style.display = "block";
        })
        .catch((err) => {
          console.log("copy error", err);
        });
    }

    genPassword();
    setInterval(function () {
      genPassword();
    }, 500);
  });

  const md5 = new (function () {
    var l = "length",
      h = [
        "0123456789abcdef",
        0x0f,
        0x80,
        0xffff,
        0x67452301,
        0xefcdab89,
        0x98badcfe,
        0x10325476,
      ],
      x = [
        [0, 1, [7, 12, 17, 22]],
        [1, 5, [5, 9, 14, 20]],
        [5, 3, [4, 11, 16, 23]],
        [0, 7, [6, 10, 15, 21]],
      ],
      A = function (x, y, z) {
        return (
          (((x >> 16) + (y >> 16) + ((z = (x & h[3]) + (y & h[3])) >> 16)) <<
            16) |
          (z & h[3])
        );
      },
      B = function (s) {
        var n = ((s[l] + 8) >> 6) + 1,
          b = new Array(1 + n * 16).join("0").split("");
        for (var i = 0; i < s[l]; i++)
          b[i >> 2] |= s.charCodeAt(i) << ((i % 4) * 8);
        return (
          (b[i >> 2] |= h[2] << ((i % 4) * 8)), (b[n * 16 - 2] = s[l] * 8), b
        );
      },
      R = function (n, c) {
        return (n << c) | (n >>> (32 - c));
      },
      C = function (q, a, b, x, s, t) {
        return A(R(A(A(a, q), A(x, t)), s), b);
      },
      F = function (a, b, c, d, x, s, t) {
        return C((b & c) | (~b & d), a, b, x, s, t);
      },
      G = function (a, b, c, d, x, s, t) {
        return C((b & d) | (c & ~d), a, b, x, s, t);
      },
      H = function (a, b, c, d, x, s, t) {
        return C(b ^ c ^ d, a, b, x, s, t);
      },
      I = function (a, b, c, d, x, s, t) {
        return C(c ^ (b | ~d), a, b, x, s, t);
      },
      _ = [F, G, H, I],
      S = (function () {
        with (Math)
        for (
          var i = 0, a = [], x = pow(2, 32);
          i < 64;
          a[i] = floor(abs(sin(++i)) * x)
        );
        return a;
      })(),
      X = function (n) {
        for (var j = 0, s = ""; j < 4; j++)
          s +=
            h[0].charAt((n >> (j * 8 + 4)) & h[1]) +
            h[0].charAt((n >> (j * 8)) & h[1]);
        return s;
      };
    return function (s) {
      var $ = B("" + s),
        a = [0, 1, 2, 3],
        b = [0, 3, 2, 1],
        v = [h[4], h[5], h[6], h[7]];
      for (
        var i, j, k, N = 0, J = 0, o = [].concat(v);
        N < $[l];
        N += 16, o = [].concat(v), J = 0
      ) {
        for (i = 0; i < 4; i++)
          for (j = 0; j < 4; j++)
            for (k = 0; k < 4; k++, a.unshift(a.pop()))
              v[b[k]] = _[i](
                v[a[0]],
                v[a[1]],
                v[a[2]],
                v[a[3]],
                $[N + (((j * 4 + k) * x[i][1] + x[i][0]) % 16)],
                x[i][2][k],
                S[J++]
              );
        for (i = 0; i < 4; i++) v[i] = A(v[i], o[i]);
      }
      return X(v[0]) + X(v[1]) + X(v[2]) + X(v[3]);
    };
  })();
</script>

</html>
